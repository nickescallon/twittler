<!DOCTYPE html>
<html>
  <head>
    <link href='http://fonts.googleapis.com/css?family=Roboto:900' rel='stylesheet' type='text/css'>
    <link rel="Stylesheet" type="text/css" href="main.css"/>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
  </head>
  <body>
    <div id="header"><span>Twittler</span></div>
    <script>

      $(document).ready(function(){
        var $body = $('body');

        var prettyDate = function(timeStamp){
          var currentDate = new Date();
          var currentTime = currentDate.getTime();
          var createdTime = Date.parse(timeStamp);
          var timeDelta = (currentTime - createdTime)/1000;

          if(timeDelta < 60){
            return "less than a minute ago";
          }else if (timeDelta >= 60 && timeDelta < 120){
            return "a minute ago";
          }else if (timeDelta >= 60 && timeDelta < 3600){
            var t = Math.floor(timeDelta/60).toString();
            return t + " minutes ago";
          }else if (timeDelta >= 3600){
            var t = Math.floor(timeDelta/3600).toString();
            return t + " hours ago";
          }
        };

        var updatePrettyDates = function() {
          $(".timestamp").each(function(){
            $(this).text(prettyDate($(this).data("created")));
          });
        }

        $tweetContainer = $('<div id="tweetContainer"></div>');
        $tweetContainer.appendTo($body);

        //initialize DisplayIndex;
        var displayIndex = 0;

        //prepends new tweets to body
        var displayNewTweets = function(){
          var index = displayIndex;
          var newLength = streams.home.length - 1;
          while(newLength >= index){
            var tweet = streams.home[index];
            $tweet = $('<div class="tweet">' +
              '<div class="heading">' +
                '<div class="user" data-username="' + tweet.user + '"><span>@' + tweet.user + '</span></div>' +
                '<div class="timestamp" data-created="' + tweet.created_at + '">' + prettyDate(tweet.created_at) + '</div>' +
              '</div>' +
              '<div class="content">' + tweet.message + '</div>' +
            '</div>');
            $tweet.prependTo($tweetContainer);
            index += 1;
            displayIndex += 1;
          }
        };

        //event handler - listens to clicks on usernames and hides tweets not from that user
        $('#tweetContainer').on('click', 'span', function(){
          var selectedUser = $(this).closest('.user').data('username');
          $('.user').each(function(){
            if($(this).data('username') != selectedUser){
              $(this).closest('.tweet').fadeOut();
            }
          });
        });

        
        //Initial Display of tweets
        displayNewTweets();

        setInterval(function(){
          displayNewTweets();
        }, 1000);

        setInterval(function(){
          updatePrettyDates();
        }, 1000);


      });

    </script>
  </body>
</html>
